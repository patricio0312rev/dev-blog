---
import { getCollection } from "astro:content";
import BaseLayout from "@/layouts/BaseLayout.astro";
import TagsPage from "@/views/TagsPage";
import { normalizeDateInput } from "@/utils";

const articles = await getCollection("articles", ({ data }) => !data.draft);

const sortedArticles = articles
  .sort(
    (a, b) =>
      normalizeDateInput(b.data.publishDate).getTime() -
      normalizeDateInput(a.data.publishDate).getTime()
  )
  .map((article) => ({
    slug: article.slug,
    title: article.data.title,
    description: article.data.description,
    category: article.data.category,
    tags: article.data.tags,
    date: article.data.publishDate,
  }));

// Extract all tags with counts
const tagCounts = new Map<string, number>();
for (const article of sortedArticles) {
  for (const tag of article.tags) {
    tagCounts.set(tag, (tagCounts.get(tag) || 0) + 1);
  }
}

const tags = Array.from(tagCounts.entries())
  .map(([name, count]) => ({ name, count }))
  .sort((a, b) => b.count - a.count);
---

<BaseLayout
  title="Tags"
  description="Browse articles by topic and discover content across different tags."
>
  <TagsPage articles={sortedArticles} tags={tags} client:load />
</BaseLayout>
